#!/bin/sh -e

# This script is run if an optical drive lacks a rule for persistent naming.
#
# It adds symlinks for optical drives based on the device class determined
# by cdrom_id and uses ID_SERIAL or ID_MODEL and ID_REVISION to
# identify the device.

# (C) 2006 Marco d'Itri <md@Linux.IT>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# debug, if UDEV_LOG=<debug>
if [ -n "$UDEV_LOG" ]; then
        if [ "$UDEV_LOG" -ge 7 ]; then
                set -x
        fi
fi

RULES_FILE="/etc/udev/rules.d/70-persistent-cd.rules"

. /lib/udev/rule_generator.functions

find_next_available() {
        raw_find_next_available "$(find_all_rules 'SYMLINK\+=' "$1")"
}

write_rule() {
        local match="$1"
        local link="$2"
        local comment="$3"

        {
        if [ "$PRINT_HEADER" ]; then
                PRINT_HEADER=
                echo "# This file was automatically generated by the $0"
                echo "# program, run by the cd-aliases-generator.rules rules file."
                echo "#"
                echo "# You can modify it, as long as you keep each rule on a single"
                echo "# line, and set the \$GENERATED variable."
                echo ""
        fi

        [ "$comment" ] && echo "# $comment"
        echo "$match, SYMLINK+=\"$link\", ENV{GENERATED}=\"1\""
        } >> $RULES_FILE
        SYMLINKS="$SYMLINKS $link"
}

if [ -z "$DEVPATH" ]; then
        echo "Missing \$DEVPATH." >&2
        exit 1
fi
if [ -z "$ID_CDROM" ]; then
        echo "$DEVPATH is not a CD reader." >&2
        exit 1
fi

# ID_PATH is gone from the ata subsystem used in recent kernels, so
# always use the by-id method:
if [ "$ID_SERIAL" ]; then
        RULE="ENV{ID_SERIAL}==\"$ID_SERIAL\""
elif [ "$ID_MODEL" -a "$ID_REVISION" ]; then
        RULE="ENV{ID_MODEL}==\"$ID_MODEL\", ENV{ID_REVISION}==\"$ID_REVISION\""
else
        echo "$DEVPATH not supported by ata_id.  Unable to generate persistent rules." >&2
        exit 1
fi

# Prevent concurrent processes from modifying the file at the same time.
lock_rules_file

# Check if the rules file is writeable.
choose_rules_file

link_num=$(find_next_available 'cdrom[0-9]*')
[ "$link_num" = "" ] && link_num=0

match="SUBSYSTEM==\"block\", ENV{ID_CDROM}==\"?*\", $RULE"

comment="$ID_MODEL ($ID_SERIAL)"
        write_rule "$match" "cdrom$link_num" "$comment"
        if [ "$link_num" = "0" ]; then
                write_rule "$match" "cdrom"
        fi

        if [ "$ID_CDROM_CD_R" ]; then
                write_rule "$match" "cdr$link_num"
                if [ "$link_num" = "0" ]; then
                        write_rule "$match" "cdr"
                fi

                write_rule "$match" "cdwriter$link_num"
                if [ "$link_num" = "0" ]; then
                        write_rule "$match" "cdwriter"
                fi

                if [ "$ID_CDROM_CD_RW" ]; then
                        write_rule "$match" "cdrw$link_num"
                        if [ "$link_num" = "0" ]; then
                                write_rule "$match" "cdrw"
                        fi
                fi

                if [ "$link_num" = "0" ]; then
                        write_rule "$match" "writer"
                fi
        fi

        if [  "$ID_CDROM_DVD" ]; then
                write_rule "$match" "dvd$link_num"
                if [ "$link_num" = "0" ]; then
                        write_rule "$match" "dvd"
                fi

                if [ "$ID_CDROM_DVD_R" -o "$ID_CDROM_DVD_RW" -o "$ID_CDROM_DVD_RAM" ]; then
                        write_rule "$match" "dvdr$link_num"
                        if [ "$link_num" = "0" ]; then
                                write_rule "$match" "dvdr"
                        fi

                        write_rule "$match" "dvdrw$link_num"
                        if [ "$link_num" = "0" ]; then
                                write_rule "$match" "dvdrw"
                        fi

                        write_rule "$match" "dvdwriter$link_num"
                        if [ "$link_num" = "0" ]; then
                                write_rule "$match" "dvdwriter"
                        fi
                fi
        fi
echo >> $RULES_FILE

unlock_rules_file

echo $SYMLINKS

exit 0
